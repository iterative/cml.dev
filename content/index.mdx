import GitFlowIcon from "media/icons/gitflow.svg"
import ReportsIcon from "media/icons/reports.svg"
import BoxIcon from "media/icons/cube.svg"

import githubVideo from "media/github/landing-video.webm"
import githubBaseCase from "media/github/base-case-report.png"
import githubDVCReport from "media/github/dvc-report.png"
import githubTensorboardReport from "media/github/tensorboard-report.png"
import githubCloudReport from "media/github/cloud-report.png"

import gitlabVideo from "media/gitlab/landing-video.webm"
import gitlabBaseCase from "media/gitlab/base-case-report.png"
import gitlabDVCReport from "media/gitlab/dvc-report.png"
import gitlabTensorboardReport from "media/gitlab/tensorboard-report.png"
import gitlabCloudReport from "media/gitlab/cloud-report.png"

import LandingVideo from "components/molecules/Video/LandingVideo"

<FullWidthBox sx={{
  backgroundColor: "text",
  color: "background",
  overflow: "hidden",
  textAlign: "center",
}}>
  <Collapser sx={{
    my: "40px",
    justifyContent: "center",
    alignItems: "center"
  }}>
    <Box sx={{flex: "1", textAlign: ["center", null, "left"]}}>
      <Heading as="h1" sx={{
        fontSize: ["32px", null, null, "42px"],
        my: 4,
        ml: 2,
        mr: [2, null, "45px"],
        maxWidth: "500px"
      }}>
        Continuous Machine Learning (CML) is CI/CD for Machine Learning Projects
      </Heading>
      <Link variant="button" href="#">
        Get Started
      </Link>
    </Box>
    <Box sx={{flex: "1", width: "100%"}}>
      <Switch sx={{ mt: 4, mx: "auto", maxWidth: ["100%", null, "160px"] }} />
      <Switchable
        gitlab={<LandingVideo src={gitlabVideo} mode="gitlab" />}
        github={<LandingVideo src={githubVideo} mode="github" />}
      />
    </Box>
  </Collapser>

  <Collapser sx={{my: 4}}>
  <HomeFeature heading="GitFlow for data science" icon={GitFlowIcon}>

Use GitLab or GitHub to manage ML experiments, track who trained ML models or
modified data and when. Codify data and models with DVC instead of pushing to
your Git repo.

  </HomeFeature>
  <HomeFeature heading="Auto reports for ML experiments" icon={ReportsIcon}>

Auto-generate reports with metrics and plots in each Git Pull Request.
Rigorous engineering practices help your team make informed, data-driven
decisions.

  </HomeFeature>
  <HomeFeature heading="No additional services" icon={BoxIcon}>

Build your own ML platform using just GitHub or GitLab and your favorite cloud
services: AWS, Azure, GCP. No databases, services or complex setup needed.

  </HomeFeature>
  </Collapser>

</FullWidthBox>

<FullWidthBox sx={{
  textAlign: "center",
  inner: {
    my: "80px",
    px: [0, null, null, 3],
  }
}}>

<Box variant="styles.CenteredBlock" sx={{px: 3, maxWidth: "615px"}}>

<Heading
  as="h2"
  sx={{
    color: "text",
    fontSize: ["32px", null, "48px"],
  }}
>
  CML User Cases
</Heading>

The simplest case of using CML, and a clear way for any user to get started, is to generate a simple report. Add the following .yaml to your project repository and commit to get started

</Box>

<Switch sx={{ my: 4, maxWidth: "160px", mx: "auto" }} />

<JSONTabs
  sx={{ "code, img": {maxHeight: "580px"} }}
  content={[
  {
    name: "First CML Report",
    filename: "cml.yaml",
    content: (
      <Switchable
        gitlab={(
<Collapser>

```yml filename=".gitlab-ci.yml" repo="https://gitlab.com/iterative.ai/cml-base-case"
stages:
  - cml_run

cml:
  stage: cml_run
  image: dvcorg/cml-py3:latest

  script:
    <Tooltip type="dependencies">
    - pip3 install -r requirements.txt
    </Tooltip>
    - python train.py

    <Tooltip type="reports">
    - cat metrics.txt >> report.md
    - cml-publish confusion_matrix.png --md --title 'confusion-matrix' >> report.md
    - cml-send-comment report.md
    </Tooltip>
```

<ImageExampleBox title="CML Report" image={gitlabBaseCase} />

</Collapser>
        )}
        github={(
<Collapser>

```yml filename="cml.yaml" repo="https://github.com/iterative/cml_base_case"
name: train-my-model

on: [push]

jobs:
  run:
    runs-on: [ubuntu-latest]
    container: docker://dvcorg/cml-py3:latest

    steps:
      - uses: actions/checkout@v2

      - name: cml_run
        env:
          repo_token: { "${{ secrets.GITHUB_TOKEN }}" }
        run: |
          <Tooltip type="dependencies">
          pip3 install -r requirements.txt
          </Tooltip>
          python train.py

          <Tooltip type="reports">
          cat metrics.txt >> report.md
          cml-publish confusion_matrix.png --md --title 'confusion-matrix' >> report.md
          cml-send-comment report.md
          </Tooltip>
```

<ImageExampleBox title="CML Report" image={githubBaseCase} />

</Collapser>
        )}
      />
    )
  },
  {
    name: "DVC",
    content: (
      <Switchable
        gitlab={(
<Collapser>

```yml filename=".gitlab-ci.yml" repo="https://gitlab.com/iterative.ai/cml-dvc-case"
stages:
  - cml_run

cml:
  stage: cml_run
  image: dvcorg/cml-py3:latest

  script:
    - apt-get --purge remove -y dvc
    - pip install "git+https://github.com/iterative/dvc#egg=dvc[s3]"

    - pip install -r requirements.txt

    - dvc pull data
    - dvc repro
    - git fetch --prune
    - dvc metrics diff --show-md master >> report.md
    - echo >> report.md

    - dvc plots diff --target loss.csv --show-vega master > vega.json
    - vl2png vega.json -s 1.5 | cml-publish --md --title "loss plot" >> report.md
    - cml-send-comment report.md
```

<ImageExampleBox title="CML Report" image={gitlabDVCReport} />

</Collapser>
        )}
        github={(
<Collapser>

```yml filename="cml.yaml" repo="https://github.com/iterative/cml_dvc_case"
name: train-my-model

on: [push]

jobs:
  run:
    runs-on: [ubuntu-latest]
    container: docker://dvcorg/cml-py3:latest

    steps:
      - uses: actions/checkout@v2

      - name: cml_run
        env:
          repo_token: { "${{ secrets.GITHUB_TOKEN }}" }
          AWS_ACCESS_KEY_ID: { "${{ secrets.AWS_ACCESS_KEY_ID }}" }
          AWS_SECRET_ACCESS_KEY: { "${{ secrets.AWS_SECRET_ACCESS_KEY }}" }
        run: |
          # Get DVC 1.0
          apt-get --purge remove -y dvc
          pip install "git+https://github.com/iterative/dvc#egg=dvc[s3]"


          pip install -r requirements.txt

          # Pull dataset with DVC
          dvc pull data

          # Reproduce pipeline if any changes detected in dependencies
          dvc repro

          # Use DVC metrics diff to compare metrics to master
          git fetch --prune --unshallow
          dvc metrics diff --show-md master >> report.md
          echo >> report.md

          # Add figure to report
          dvc plots diff --target loss.csv --show-vega master > vega.json
          vl2png vega.json -s 1.5 | cml-publish --md --title "loss plot" >> report.md
          cml-send-comment report.md
```

<ImageExampleBox title="CML Report" image={githubDVCReport} />

</Collapser>
        )}
      />
    )
  },
  {
    name: "Tensorboard",
    content: (
      <Switchable
        gitlab={(
<Collapser>

```yml filename=".gitlab-ci.yml" repo="https://gitlab.com/iterative.ai/cml-tensorboard-case"
stages:
  - cml_run

cml:
  stage: cml_run
  image: dvcorg/cml-py3:latest

  script:
    - pip install -r requirements.txt

    # Start tensorboard and train
    - cml-tensorboard-dev --logdir logs --md --name "Go to tensorboard" >> report.md
    - cml-send-comment report.md
    - python train.py
```

<ImageExampleBox title="CML Report" image={gitlabTensorboardReport} />

</Collapser>
        )}
        github={(
<Collapser>

```yml filename="cml.yaml" repo="https://github.com/iterative/cml_tensorboard_case"
name: train-my-model

on: [push]

jobs:
  run:
    runs-on: [ubuntu-latest]
    container: docker://dvcorg/cml-py3:latest

    steps:
      - uses: actions/checkout@v2

      - name: cml_run
        env:
          repo_token: { "${{ secrets.GITHUB_TOKEN }}" }
          TB_CREDENTIALS: { "${{ secrets.TB_CREDENTIALS }}" }
        run: |
          pip3 install -r requirements.txt

          cml-tensorboard-dev --logdir logs --md --name "Go to tensorboard" >> report.md
          cml-send-comment report.md
          python train.py
```

<ImageExampleBox title="CML Report" image={githubTensorboardReport} />

</Collapser>
        )}
      />
    )
  },
  {
    name: "Cloud Computing",
    content: (
      <Switchable
        gitlab={(
<Collapser>

```yml filename=".gitlab-ci.yml" repo="https://gitlab.com/iterative.ai/cml-cloud-case"
# TBD: This placeholder is just a copy of the GitHub one.

name: style-transfer

on: [push]

jobs:
  deploy-cloud-runner:
    runs-on: [ubuntu-latest]
    container: docker://dvcorg/cml-gpu-cloud-runner

    steps:
      - name: deploy
        env:
          repo_token: ${'{{ secrets.REPO_TOKEN }}'}
          AWS_ACCESS_KEY_ID: ${'{{ secrets.AWS_ACCESS_KEY_ID }}'}
          AWS_SECRET_ACCESS_KEY: ${'{{ secrets.AWS_SECRET_ACCESS_KEY }}'}
        run: |
          echo "Deploying..."
          RUNNER_LABELS="cml,aws"
          RUNNER_REPO="https://gitlab.com/iterative/cml_cloud_case"
          MACHINE="cml$(date +%s)"
          docker-machine create \
            --driver amazonec2 \
            --amazonec2-instance-type g3s.xlarge \
            --amazonec2-vpc-id vpc-76f1f01e \
            --amazonec2-region us-east-2 \
            --amazonec2-zone a \
            --amazonec2-ssh-user ubuntu \
            --amazonec2-ami ami-07b11e59bc74961b5 \
            --amazonec2-root-size 64 \
            $MACHINE
          eval "$(docker-machine env --shell sh $MACHINE)"
          (
          docker-machine ssh $MACHINE "sudo mkdir -p /docker_machine && sudo chmod 777 /docker_machine" && \
          docker-machine scp -r -q ~/.docker/machine/ $MACHINE:/docker_machine && \
          docker run --name runner --gpus all -d \
            -v /docker_machine/machine:/root/.docker/machine \
            -e DOCKER_MACHINE=$MACHINE \
            -e repo_token=$repo_token \
            -e RUNNER_LABELS=$RUNNER_LABELS \
            -e RUNNER_REPO=$RUNNER_REPO \
            -e RUNNER_IDLE_TIMEOUT=120 \
            dvcorg/cml-gpu-py3-cloud-runner:latest && \
          sleep 20 && echo "Deployed $MACHINE"
          ) || (docker-machine rm -y -f $MACHINE && exit 1)
  train:
    needs: deploy-cloud-runner
    runs-on: [self-hosted,cml]

    steps:
      - uses: actions/checkout@v2

      - name: cml_run
        env:
          repo_token: ${'{{ secrets.REPO_TOKEN}}'}
        run: |
          apt-get update -y
          apt-get install python3-dev -y
          apt install imagemagick -y
          pip install -r requirements.txt

          # DVC stuff
          git fetch --prune
          dvc repro

          echo "# Style transfer" >> report.md
          git show origin/master:final_owl.png > master_owl.png
          convert +append final_owl.png master_owl.png out.png
          convert out.png -resize 75%  out_shrink.png
          echo "### Workspace vs. Master" >> report.md
          cml-publish out_shrink.png --md --title 'compare' >> report.md

          echo "## Training metrics" >> report.md
          dvc params diff master --show-md >> report.md

          echo >> report.md
          echo "## GPU info" >> report.md
          cat gpu_info.txt >> report.md

          cml-send-comment report.md
```

<ImageExampleBox title="CML Report" image={gitlabCloudReport} />

</Collapser>
        )}
        github={(
<Collapser>

```yml filename="cml.yaml" repo="https://github.com/iterative/cml_cloud_case"
name: style-transfer

on: [push]

jobs:
  deploy-cloud-runner:
    runs-on: [ubuntu-latest]
    container: docker://dvcorg/cml-gpu-cloud-runner

    steps:
      - name: deploy
        env:
          repo_token: ${'{{ secrets.REPO_TOKEN }}'}
          AWS_ACCESS_KEY_ID: ${'{{ secrets.AWS_ACCESS_KEY_ID }}'}
          AWS_SECRET_ACCESS_KEY: ${'{{ secrets.AWS_SECRET_ACCESS_KEY }}'}
        run: |
          echo "Deploying..."
          RUNNER_LABELS="cml,aws"
          RUNNER_REPO="https://github.com/iterative/cml_cloud_case"
          MACHINE="cml$(date +%s)"
          docker-machine create \
            --driver amazonec2 \
            --amazonec2-instance-type g3s.xlarge \
            --amazonec2-vpc-id vpc-76f1f01e \
            --amazonec2-region us-east-2 \
            --amazonec2-zone a \
            --amazonec2-ssh-user ubuntu \
            --amazonec2-ami ami-07b11e59bc74961b5 \
            --amazonec2-root-size 64 \
            $MACHINE
          eval "$(docker-machine env --shell sh $MACHINE)"
          (
          docker-machine ssh $MACHINE "sudo mkdir -p /docker_machine && sudo chmod 777 /docker_machine" && \
          docker-machine scp -r -q ~/.docker/machine/ $MACHINE:/docker_machine && \
          docker run --name runner --gpus all -d \
            -v /docker_machine/machine:/root/.docker/machine \
            -e DOCKER_MACHINE=$MACHINE \
            -e repo_token=$repo_token \
            -e RUNNER_LABELS=$RUNNER_LABELS \
            -e RUNNER_REPO=$RUNNER_REPO \
            -e RUNNER_IDLE_TIMEOUT=120 \
            dvcorg/cml-gpu-py3-cloud-runner:latest && \
          sleep 20 && echo "Deployed $MACHINE"
          ) || (docker-machine rm -y -f $MACHINE && exit 1)
  train:
    needs: deploy-cloud-runner
    runs-on: [self-hosted,cml]

    steps:
      - uses: actions/checkout@v2

      - name: cml_run
        env:
          repo_token: ${'{{ secrets.REPO_TOKEN}}'}
        run: |
          apt-get update -y
          apt-get install python3-dev -y
          apt install imagemagick -y
          pip install -r requirements.txt

          # DVC stuff
          git fetch --prune
          dvc repro

          echo "# Style transfer" >> report.md
          git show origin/master:final_owl.png > master_owl.png
          convert +append final_owl.png master_owl.png out.png
          convert out.png -resize 75%  out_shrink.png
          echo "### Workspace vs. Master" >> report.md
          cml-publish out_shrink.png --md --title 'compare' >> report.md

          echo "## Training metrics" >> report.md
          dvc params diff master --show-md >> report.md

          echo >> report.md
          echo "## GPU info" >> report.md
          cat gpu_info.txt >> report.md

          cml-send-comment report.md
```

<ImageExampleBox title="CML Report" image={githubCloudReport} />

</Collapser>
        )}
      />
    )
  }
]}/>

</FullWidthBox>

<FullWidthBox sx={{
  backgroundColor: "gray",
  textAlign: "center",
  py: "5px",
  inner: {
    my: "85px",
  },
}}>

<Box sx={{
  maxWidth: "460px",
  mx: "auto",
  letterSpacing: "0.02em",
  fontSize: "18px",
}}>

<Heading
  as="h2"
  sx={{
    color: "text",
    fontSize: ["32px", null, "48px"],
  }}
>
  What is CML?
</Heading>

CML is an easy way of combining the codified parts of your MLOps stack into a single solution.

</Box>

<SolutionList
  sx={{
    maxWidth: "834px",
    my: "40px",
    mx: "auto",
  }}
>
  {[
    ["Codify workflow", "GitHub Actions and GitLab CI"],
    ["Codify environment", "Docker or Packer"],
    ["Codify ML infrastructure", "Terraform or docker-machine"],
    ["ML experiment reports", "open source CML library"],
  ]}
</SolutionList>

</FullWidthBox>
